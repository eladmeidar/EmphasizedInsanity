<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
        <title>Emphasized Insanity - Creating a Rails authentication system on Mongoid Part 2 - Remember me and Account activation</title>
		<link href="/stylesheets/bundle_github.css" media="screen" rel="stylesheet" type="text/css">
    <link href="/stylesheets/bundle_common.css" media="screen" rel="stylesheet" type="text/css">
    <script type="text/javascript" charset="utf-8">
      var GitHub = {}
      var github_user = 'eladmeidar'
      
    </script>
    <script src="/javascripts/jquery.js" type="text/javascript"></script>
    <script src="/javascripts/bundle_common.js" type="text/javascript"></script>
		<script src="/javascripts/bundle_github.js" type="text/javascript"></script>
		<link href="http://blog.eizesus.com/feed/atom.xml" rel="alternate" title="Emphasized Insanity" type="application/atom+xml">

    <meta name="description" content="Ruby on Rails developer blog">
  </head>
<body>
 
    <div class="subnavd" id="main">
      <div id="header" class="pageheaded">
        <div class="site">
          <div class="logo">
            <a href="/"><h1>Emphasized Insanity</h1></a>
          </div>          
			     <div class="userbox">
				     <div class="inner">
				       <div class="avatarname">
				         <a href="http://github.com/eladmeidar"><img alt="" src="/images/eladmeidar.jpg" height="20" width="20"></a>
				         <a href="http://twitter.com/eladmeidar" class="name">@eladmeidar</a>          
				       </div>
				       <ul class="usernav">
								 <li><a href="/about.html">About me</a></li>
				         <li><a href="http://www.linkedin.com/in/eladmeidar">LinkedIn</a></li>
				         <li><a href="http://workingwithrails.com/person/5844-elad-meidar">WWR</a></li>
				         <li><a href="http://github.com/eladmeidar">GitHub</a></li>
								 <li><a href="http://www.nautilus6.com">My Company</a></li>
				       </ul>
				     </div>
				   </div><!-- /.userbox -->
					 <div class="topsearch">
  
				    <form action="http://www.google.com/search?sitename=blog.eizesus.com" id="top_search_form" method="get">
				      <input autocomplete="off" class="search my_repos_autocompleter notnative placeholder ac_input" name="q" results="5" placeholder="Search…" type="search"> <input value="Search" class="button" type="submit">
								<input type="hidden" name="sitesearch" value="blog.eizesus.com" checked=""/>
				    </form>
  
  						<ul class="nav">
					      <li><a href="/archive.html">Explore Emphasized Insanity</a></li>
					    </ul>
  
						</div>

        </div>
      </div>        
    <div class="site">
      <div class="pagehead repohead vis-public">
        <h1> <a href="/">Emphasized Insanity</a> / <strong><a href="/">Blog</a></strong> </h1>
				<ul class="actions">
	        <li> <a href="http://blog.eizesus.com/feed/atom.xml" class="minibutton btn-watch " id="watch_button" style=""><span><span class="icon"></span>Subscribe</span></a></li>        
	        <li class="for-notforked" style=""><a href="#disqus-comments" class="minibutton btn-fork " id="fork_button"><span><span class="icon"></span>Comment</span></a></li>
    	  </ul>
				<ul class="tabs">
  				<li><a href="/" class="selected" highlight="repo_source">Source</a></li>
					<li><a href="/archive.html" highlight="repo_commits">Archive</a></li>
					<li><a href="http://www.railsbridge.org" highlight="issues">RailsBridge</a></li>
  				<li class="contextswitch nochoices">
				    <span class="toggle leftwards">
				      <em>Branch:</em>
				      <code>master</code>
				    </span>
				  </li>
				</ul>

<div class="subnav-bar">  
  <ul>
    <li>
      <a href="#" class="dropdown">Switch Branches (1)</a>
      <ul>
				<li><strong>master ✓</strong></li>
      </ul>
    </li>
  </ul>
</div> 
    <div id="repo_details" class="metabox clearfix  pledgified">
      <div id="repo_details_loader" class="metabox-loader" style="display: none;">Sending Request…</div>
        <a href="#pledgie_box" rel="facebox" title="Brought to you by pledgie.com" class="pledgie pledgie-button for-owner tooltipped" id="activate_pledgie_button" style="display: none;"><span>Enable Donations</span></a>
      		<div id="pledgie_box" style="display: none;">
        		<h2>Pledgie Donations</h2>
          </div>

      		<div id="repository_description" rel="repository_description_edit">
						<p>
							This is the personal homepage of Elad Meidar, a web developer and an entrepreneur specializing in Ruby on Rails. I am a proud member of <a href="http://www.railsbridge.org">RailsBridge</a>, Helping new <a href="http://www.railsmentors.org/users/185">Rails developers</a> get into our world and also contributed a few <a href="http://contributors.rubyonrails.org/contributors/elad-meidar/commits">Patches</a> to the Ruby on Rails core.
						</p>
						<p>
							I hang around Fort Lauderdale, FL and Tel-Aviv in Israel, and i am currently running <a href="http://www.nautilus6.com">Nautilus6</a> so Feel free to contact me regarding projects :).
						</p>
      		</div>
    		</div>
    </div><!-- /.pagehead -->
  <div id="commit">
    <div class="group">        
  		<div class="envelope commit">
    		<div class="human">
        <div class="message"><pre>Recent Posts</pre></div>
      

      <div class="actor">
        <div class="gravatar">
          <img alt="" src="images/eladmeidar.jpg" height="30" width="30">
        </div>
        <div class="name"><a href="/">Elad Meidar</a>
	 				<span>(author)</span>
				</div>
        <div class="date">
          <abbr class="relatize relatized" title="1984-06-19 06:06:07">about 25 years ago</abbr>
        </div>
      </div>
    </div>
    <div class="machine">
      <span>c</span>ommit&nbsp;&nbsp;<a href="#" hotkey="c">60fa264c54341711baef087347105a5b9dd68863</a><br>
      <span>t</span>ree&nbsp;&nbsp;&nbsp;&nbsp;<a href="#" hotkey="t">508268ee6774e5c6060585718705f1ec7afa80d8</a><br>
        <span>p</span>arent&nbsp; <a href="#" hotkey="p">179f7c0440e6073779efc40366c6ced3a9888f71</a>    
    </div>
  </div>

    </div>
  </div>  
    <div id="path">
      <b><a href="/2010/03/creating-a-rails-authentication-system-on-mongoid-part-2-7-3-2010">Creating a Rails authentication system on Mongoid Part 2 - Remember me and Account activation</a></b> / 
    </div>
		<div id="browser">
  		<table cellpadding="0" cellspacing="0">
    	<tbody><tr>
      <th></th>
      <th width="400p">name</th>
      <th>age</th>
      <th>
          history
      </th>
    </tr>
		<tr class="alt">
		  <td class="icon"> <img alt="file" src="/images/txt.png"> </td>
		  <td class="content">
				<a href="/2010/03/creating-a-rails-authentication-system-on-mongoid-part-2-7-3-2010" id="d8f8d46921aa81abc4c0d27703a8908333ae38c3">Creating a Rails authentication system on Mongoid Part 2 - Remember me and Account activation</a>
			</td>
		  <td class="age">
				<span class="relatize relatized">07/03/2010</span> 
			</td>
		  <td class="message"> 
				<a href="/2010/03/creating-a-rails-authentication-system-on-mongoid-part-2-7-3-2010" class="message" title="another post">Another post</a> [Elad Meidar] 
			</td>
		</tr>
  </tbody></table>
</div>
  <div id="readme" class="announce"><span class="name"></span>
		<div class="wikistyle">
				<p>On the first part of <a href="http://blog.eizesus.com/2010/03/creating-a-rails-authentication-system-on-mongoid/">Creating a Rails authentication system on Mongoid</a> we tackled the basic structure of our authentication system. In this part we&#8217;ll tackle our need in creating a &#8220;Remember me&#8221; functionality to allow users to login from a cookie and a basic account activation process.</p>
<p>As a general thumb rule to this experience we try not to re-invent the wheel when we can, which basically means that we look at the existing authentication libraries source code and try to see if it has some kind of a problem on Mongo, if it doesn&#8217;t we use it and i if does we fix it as you read in the first part.</p>
<p>Out of all the authentication libraries we examined (and dropped for this cause) the one i liked the most and in my opinion the simplest yet complete is &#8220;Restful Authentication&#8221;, so we chose it as our base line and we use code snippets from it when ever we can.</p>
<h4>Remember me?</h4>
<p>The remember me functionality allows the user to login using a generated token that is found on a cookie we create, this allows the user to login without putting his user name and password <strong>everytime</strong> they want to login as long as the cookie was not expired.</p>
<p>The first thing we need to do to allow a login from cookie, is to get our User model familiar with some new fields and methods to make that process possible.</p>
<p>First, we need to add a few fields to our user document and a add a few methods to instance and class, this is our new <code>User.rb</code>:</p>
<h5>User.rb changes</h5>
<p>We changed <code>User.rb</code> a bit:</p>
<script src="http://gist.github.com/324635.js?file=User.rb"></script><p>We <strong>added 2 fields</strong>, <code>remember_token_expires_at</code> and <code>remember_token</code>, both to keep a token and and an expiry limit.<br />
We also added the following instance methods:</p>
<ul>
	<li><strong>remember_token?</strong> &#8211; determines if a token should and can be remembered.</li>
	<li><strong>remember_me</strong> &#8211; generates and saves the token and expiry limit.</li>
	<li><strong>refresh_token</strong> &#8211; creates a new token.</li>
	<li><strong>forget_me</strong> &#8211; cleans the token and expiry limit fields.</li>
</ul>
<p>we also added the following class methods:</p>
<ul>
	<li><strong>User.secure_digest</strong> &#8211; a wrapper to our encryption method.</li>
	<li><strong>User.make_token</strong> &#8211; generates a new token.</li>
</ul>
<p>Now that we changed some of the options for our session management, we will need to update <code>sessions_controller</code> and <code>application_controller</code> as well.</p>
<h5>ApplicationController changes</h5>
<p>In the end of Part 1, i gave an example to some methods that should be on <code>application_controller</code> in order to make the session management and the entire authentication process easier. Since those were just examples and were meant barely to support basic usage, we will need to go through it a bit more seriously and create a more precise and smart <code>application_controller</code>.</p>
<p>In this case, we can simply grab all the methods from Restful Authentication&#8217;s <code>authentication.rb</code> module, and weld it to our <code>application_controller</code>:</p>
<script src="http://gist.github.com/324641.js?file=application_controller.rb"></script><p>we added a few methods and changed a few existing ones, this is pretty straight forward and basically a 1:1 copy from Restful Authentication, the only important thing to really pay attention to are the <code>current_user</code> and the <code>current_user=</code> which are different than what we had in my previous example and now takes more into consideration (cookies and HTTPauth for example.)</p>
<p>Since now we have a getter for <code>current_user</code> we need to change our <code>sessions_controller</code> too.</p>
<h5>SessionsController changes</h5>
<p>This is our current <code>sessions_controller</code>:</p>
<script src="http://gist.github.com/324647.js?file=sessions_controller.rb"></script><p>note the &#8220;remember me&#8221; functionality consideration and the usage of our cookie-based-login methods from <code>application_controller</code>.</p>
<p>Now you can simply add a checkbox named &#8220;remember_me&#8221; to your <code>SessionsController#new</code> form, but i am sure you can do that without a gist :)</p>
<h4>Activation</h4>
<p>&#8220;Account Activation&#8221; is generally a process that is meant to make sure the user who filled the registration form really has access to the email account by sending that address a message with a token-generated link that upon clicked, proves ownership of this email address and activates the account.</p>
<h5>User.rb</h5>
<p>We had to find a solution to annotate the user instance with it&#8217;s current activation status, with that given we figured we have 2 options to tackle it:</p>
<ul>
	<li>simple add a boolean field to store the current activation status</li>
	<li>use some kind of a state machine that will allow us some more flexibility later</li>
</ul>
<p>Bearing in mind that we won&#8217;t need more than a single status, we decided to go with the first option and simply add an <code>active</code> boolean field, an <code>activation_code</code> token field and an <code>activated_at</code> timestamp. we also added those fields to our <code>attr_protected</code> list since we don&#8217;t really want them changed by mass-assignment.</p>
<script src="http://gist.github.com/324659.js?file=user.rb"></script><p>We also added a simple <code>before_create</code> methods that will generate an activation token for our user and a method to <code>activate!</code> the user.</p>
<p>Given the key step in an activation process is the step where your application sends the user an email message with the activation link so we&#8217;ll need to find a good way to send out an activation email when a user is created.</p>
<p>As far as outgoing emails best practices goes, it&#8217;s better not to preform the <code>ActionMailer#deliver_...</code> method in the controller itself, but to:</p>
<ul>
	<li>Use an observer that will send that email when the current callback is fired. In our case that would be an <code>after_create</code> observer on the User model.</li>
	<li>Offload the task to some kind of a background processor such as DelayedJob or Resque.</li>
</ul>
<p>A quick check in the Mongoid source-code revealed that we don&#8217;t have support for Observers so that option is ruled out (again, until a patch arrives). As for a background processor, while DelayedJob has an ActiveRecord dependency Resque is pretty much free and relies on Redis so we decided to use Resque in our application.</p>
<p>I&#8217;ll cover the email management on one of the next posts, but for now we&#8217;ll just use an <code>after_create</code> callback on the User model that will perform a regular <code>ActionMailer</code> delivery.</p>
<h5>UsersController changes (and a bonus mailer)</h5>
<p>Since we take care of the email notification on the model level (for now, until we offload it to a background processor later) we don&#8217;t need to change our <code>UsersController#create</code> methods, but we do need to add an action that will take care of the activation for us:</p>
<script src="http://gist.github.com/324700.js?file=users_controller.rb"></script><p>Remember to update your routes and either:</p>
<ul>
	<li>add a <code>:collection =&gt; {:activate =&gt; :get}</code> to your <code>map.users</code> routes.</li>
	<li>add a named route like <code>map.activate '/users/activate/:activation_code, :controller =&gt; 'users', :action =&gt; 'activate'</code></li>
</ul>
<p>we chose to add a <strong>named route</strong>, just because it makes more sense and that the <code>activate</code> action is not a collection action, but not one that requires an <code>id</code> too.</p>
<p>Here are a <a href="http://gist.github.com/324719">sample user mailer</a> and an <a href="http://gist.github.com/324722">activation mail view</a> if you really need them :)</p>
<h4>Conclusion</h4>
<p>In this part we didn&#8217;t ran into <strong>that</strong> many issues because we use Mongoid, the only real problem was the lack of observers but since we are going to offload the email sending process to a background processor, it doesn&#8217;t really matter.<br />
In the next part, we&#8217;ll tackle password resets and background processing.</p>
		</div>
		<div id="disqus_thread"></div><script type="text/javascript" src="http://disqus.com/forums/emphasizedinsanity/embed.js"></script><noscript><a href="http://emphasizedinsanity.disqus.com/?url=ref">View the discussion thread.</a></noscript><a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
	</div>
</div>
    <div class="push"></div>
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
          </div>
					<div class="company">
						<script type="text/javascript" src="http://s51.sitemeter.com/js/counter.js?site=s51eizesusrulez"></script>
						<a href="http://feeds.feedburner.com/EladOnRails"><img src="http://feeds.feedburner.com/~fc/EladOnRails?bg=FFFFFF&amp;fg=660033&amp;anim=0" height="26" width="88" style="border:0" alt="" /></a>
					</div>
        </div>
				
        <div class="sponsor">
          <div>
        	</div>
      	</div>
    </div>
    
    
      <div id="facebox" style="display: none;">       <div class="popup">
         <table>           <tbody>             <tr>               <td 
class="tl"></td><td class="b"></td><td class="tr"></td>             </tr>
             <tr>               <td class="b"></td>               <td 
class="body">                 <div class="content">                 </div>
                 <div class="footer">                   <a href="#" 
class="close">                     <img src="index_files/closelabel.gif"
 title="close" class="close_image">                   </a>              
   </div>               </td>               <td class="b"></td>         
    </tr>             <tr>               <td class="bl"></td><td 
class="b"></td><td class="br"></td>             </tr>           </tbody>
         </table>       </div>     </div></body></html>