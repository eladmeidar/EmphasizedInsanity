<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>Emphasized Insanity - Force Fragment caching in a Rails model</title>
  <style>
    body { background-color: #fff; color: #333; }

    body, p, ol, ul, td {
      font-family: verdana, arial, helvetica, sans-serif;
      font-size:   13px;
    }

    pre {
      background-color: #eee;
      font-size: 11px;
	  padding:10px;
    }
	
	.gist pre {
		font-size:13px;
	}
	.entry {
		margin-top:10px;
		background:#eee;
		padding:10px;
	}
	
	h2 { margin:0px; padding:0px ;}
    a { font-weight:bolder; color: #000; }
    a:hover { color: #fff; background-color:#000; }
  </style>
</head>
<body>

<h1>
  Exception Caught
  
    in EladMeidar#life
</h1>
<pre>uninitialized constant Insanity</pre>



<p><code>RAILS_ROOT: <a href="http://blog.eizesus.com">http://blog.eizesus.com</a></code></p>

<div id="traces"> 
    <a href="#" onclick="document.getElementById('Framework-Trace').style.display='none';document.getElementById('Full-Trace').style.display='none';document.getElementById('Application-Trace').style.display='block';; return false;">Application Trace</a> |
    <a href="#" onclick="document.getElementById('Application-Trace').style.display='none';document.getElementById('Full-Trace').style.display='none';document.getElementById('Framework-Trace').style.display='block';; return false;">Framework Trace</a> |
    <a href="#" onclick="document.getElementById('Application-Trace').style.display='none';document.getElementById('Framework-Trace').style.display='none';document.getElementById('Full-Trace').style.display='block';; return false;">Full Trace</a> 
    <div id="Application-Trace" style="display: block;">
		 
 
<div class="entry">
 
  <div class="entrytitle">
    <h2><a href="/2009/07/29/force-fragment-caching-in-a-rails-model.html">Force Fragment caching in a Rails model</a> <span class="author">Elad Meidar</span></h2> 
    <h3>29 Jul 2009</h3>
  </div>
  
  <div class="entrybody">
    <p>When you are syndicating information that many users on your sites share, caching can easily save your life.<br />
One form of caching on Rails is called <strong>fargment caching</strong>, which you can read all about it in the fantastic <a href="http://guides.rubyonrails.org/caching_with_rails.html">Caching with Rails</a> guide.</p>
<p>Longer story short, Fragment caching allows you to cache a small partial of your rendered view instead of an action / page cache.<br />
it&#8217;s generally used for private user content that does not change too ofter, or to small partials of repetitive data that needs to be shared between many users (search results for example).</p>
<p>When Rails sees that you asked to cache something, it tries to fetch it. If it does not exists, it creates it, simple.</p>
<p>But what if you <span class="caps"><span class="caps">KNOW</span></span> that you need it on cache and don&#8217;t want to wait to a request to cache that item, but you want to cache it immediately ?</p>
<p>Let&#8217;s try an example, this is an Article model:<br />
<pre><br />
class Article &lt; ActiveRecord::Base<br />
  validates_presence_of :title, :author_name<br />
end<br />
</pre></p>
<p>and a matching fragment cached partial, that renders a search result <span class="caps"><span class="caps">HTML</span></span> for a single search result<br />
<pre><br />
&lt;% cache &#8220;search_result_&#8221; + article.id.to_s do <span>&gt;<br />
  <div class="article_result"><br />
    &lt;</span>= article.title <span>&gt; by &lt;</span>= article.author_name %&gt;</p>
</div>
<p>&lt;% end %&gt;<br />
</pre></p>
<div class="note">
<p>For this example we assume that the Article fields will never change, although that in real life you should be ready for that situtation. If you will follow the conventions, you&#8217;ll have no problem expiring a forced fragment.</p>
</div>
<p>the search results page would probably look something like:<br />
<pre><br />
<div id="results"><br />
  &lt;%= render :partial =&gt; &#8216;article_result&#8217;, :collection =&gt; @articles %&gt;</p>
</div>
<p></pre></p>
<p>Now, we will change our Article model to ensure we create the cached search result cached version, upon create:<br />
<pre><br />
class Article &lt; ActiveRecord::Base<br />
  validates_presence_of :title, :author_name</p>
<p>after_create :force_fragment_cache<br />
def force_fragment_cache</p>
<ol>
	<li>We create the same key we would have created if we were caching in the view.<br />
    key = &#8220;search_result_&#8221; + self.id.to_s<br />
    av = ActionView::Base.new(Rails.configuration.view_path)<br />
    Rails.cache.write(<br />
      key, <br />
      av.render(<br />
        :partial =&gt; &#8220;search/article_result&#8221;, <br />
        :locals =&gt; {:article =&gt; self}<br />
      )<br />
    )<br />
  end<br />
end<br />
</pre></li>
</ol>
<p>And voila! all future requests for this article instance search result partial, will be served from cache. (as long as you have caching enabled).</p>
  </div>
  
  <div id="related">
    <h2>Related Posts</h2>
    <ul class="posts">
      
        <li><span>04 Nov 2009</span> &raquo; <a href="/2009/11/04/bag-o-links-3-11-2009.html">Bag O' Links - 3/11/2009</a></li>
      
        <li><span>30 Oct 2009</span> &raquo; <a href="/2009/10/30/bag-o-links-30-10-2009.html">Bag O' Links - 30/10/2009</a></li>
      
        <li><span>28 Oct 2009</span> &raquo; <a href="/2009/10/28/using-blackbird-javascript-console-in-rails.html">Using BlackBird javascript console in Rails</a></li>
      
    </ul>
  </div>
  
  
</div>
    </div>
    <div id="Framework-Trace" style="display: none;">
    </div>
  
    <div id="Full-Trace" style="display: none;">
		<div id="twitter_div">
			<ul id="twitter_update_list"></ul>
		</div>
    </div>
</div>

<h2 style="margin-top: 30px">Request</h2>
<p><b>Parameters</b>: <pre>None</pre></p>

<p><a href="#" onclick="document.getElementById('session_dump').style.display='block'; return false;">Show session dump</a></p>
<div id="session_dump" style="display:none"><pre class='debug_dump'>--- 
</pre></div>


<h2 style="margin-top: 30px">Response</h2>
<p><b>Headers</b>: <pre>{&quot;Content-Type&quot;=&gt;&quot;&quot;,
 &quot;Cache-Control&quot;=&gt;&quot;no-cache&quot;}</pre></p>

<script type="text/javascript" src="http://twitter.com/javascripts/blogger.js"></script>
<script type="text/javascript" src="http://twitter.com/statuses/user_timeline/eladmeidar.json?callback=twitterCallback2&amp;count=10"></script>
</body>
</html>